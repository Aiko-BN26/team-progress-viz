# エンドポイント一覧（最終版）

### エラーレスポンスの傾向
エラーレスポンスの形式はコントローラによって異なります。以下に分類して説明します。

- **組織関連コントローラ** (`io.github.aikobn26.teamprogressviz.controller.organization.*` および `repository.*`):  
  エラーレスポンスは以下の形式です。
  ```json
  {
    "type": "/errors/...",
    "title": "...",
    "status": <number>,
    ...
  }
  ```
  バリデーションエラーや権限エラーなどで使用されます。

- **ジョブコントローラ** (`JobController`):  
  エラーレスポンスは以下の形式です。
  ```json
  {
    "type": "/errors/not-found",
    ...
  }
  ```
  主にジョブが見つからない場合に使用されます。

- **GitHub関連コントローラ** (`github.controller.*`):  
  エラーレスポンスは以下の形式です。
  ```json
  {
    "error": "..."
  }
  ```
  GitHub API のエラーや認証失敗時に使用されます。

- **認証・ユーザー系コントローラ** (`AuthController`, `UserController`):  
  バリデーション失敗時は 400 または 500 で以下の形式を返します。
  ```json
  {
    "error": "..."
  }
  ```
  401（未認証）の場合は本文なしです。

- **その他のケース**:  
  500（内部サーバーエラー）の場合は共通で以下の形式を返しますが、場合によっては本文なしの場合もあります。
  ```json
  {
    "type": "/errors/internal-server-error",
    ...
  }
  ```

---

## 認証・ユーザー API

#### GET `/api/auth/github/login`
- 認証: 不要
- 概要: GitHub OAuth の Authorization URL を生成し、セッションに state を保存します。
- 成功 200
```json
{
  "authorizationUrl": "https://github.com/login/oauth/authorize?..."
}
```

#### GET `/api/auth/github/callback`
- 認証: 不要
- 概要: GitHub からのリダイレクトを処理し、アクセストークンとユーザー情報をセッションへ格納。
- 成功 302: `Location: <frontend>/auth/callback?status=success`
- 失敗 302: `Location: <frontend>/auth/callback?status=error&message=...`

#### GET `/api/auth/session`
- 認証: 必須
- 概要: セッションに紐づく GitHub 認証済みユーザー（`AuthenticatedUser`）を返します。
- 成功 200
```json
{
  "id": 12345,
  "login": "octocat",
  "name": "Octocat",
  "avatarUrl": "https://..."
}
```
- 未認証 401: 空本文

#### POST `/api/auth/logout`
- 認証: 必須
- 概要: セッションを破棄。
- 成功 204 (本文なし)

#### GET `/api/users/me`
- 認証: 必須
- 概要: 永続化済みユーザー情報（`UserResponse`）を返します。存在しない場合は作成されます。
- 成功 200
```json
{
  "id": 1,
  "githubId": 12345,
  "login": "octocat",
  "name": "Octocat",
  "avatarUrl": "https://..."
}
```
- 未認証 401

#### DELETE `/api/users/me`
- 認証: 必須
- 概要: ユーザーをソフトデリートする非同期ジョブを登録し、セッションを破棄。
- 成功 202 (`JobSubmissionResponse`)
```json
{
  "jobId": "job-delete-user-xxxx",
  "status": "queued"
}
```
- 未認証 401

---

## 組織管理 API (`/api/organizations`)

#### GET `/api/organizations`
- 認証: 必須
- 概要: 参加中の組織一覧を `OrganizationSummaryResponse` 配列で返却。
- 成功 200
```json
[
  {
    "id": 10,
    "githubId": 999999,
    "login": "team",
    "name": "Team",
    "avatarUrl": "https://...",
    "description": "sample"
  }
]
```

#### POST `/api/organizations`
- 認証: 必須 (アクセストークン必須)
- 概要: GitHub から組織情報を取得し登録。リポジトリ・メンバー同期と活動取得ジョブを非同期で開始。
- リクエストボディ (`OrganizationRegistrationRequest`)
```json
{"login": "team", "defaultLinkUrl": "https://example.com"}
```
- 成功 202 (`OrganizationRegistrationResponse`)
```json
{
  "organizationId": 10,
  "githubId": 999999,
  "login": "team",
  "name": "Team",
  "htmlUrl": "https://github.com/team",
  "status": "queued",
  "jobId": "job-sync-org-xxxx",
  "syncedRepositories": 12
}
```
- 競合 409 / バリデーション 400 は `type/title/status` 形式

#### POST `/api/organizations/{organizationId}/sync`
- 認証: 必須 (アクセストークン必須)
- 概要: 特定組織の GitHub 同期ジョブを起動。
- 成功 202
```json
{
  "jobId": "job-sync-org-xxxx",
  "status": "queued"
}
```

#### GET `/api/organizations/{organizationId}/sync/status`
- 認証: 必須
- 概要: リポジトリ同期状態一覧 (`RepositorySyncStatusResponse`)。
```json
[
  {
    "repositoryId": 100,
    "repositoryFullName": "team/app",
    "lastSyncedAt": "2025-01-16T00:00:00Z",
    "lastSyncedCommitSha": "abc123",
    "errorMessage": null
  }
]
```

#### GET `/api/organizations/{organizationId}`
- 認証: 必須
- 概要: 組織詳細 (`OrganizationDetailResponse`)。組織情報、メンバー、リポジトリ概要、直近 7 日の活動サマリー、PR サマリー、最新 PR・コミット・コメントを返却。
- 成功 200: レスポンスは入れ子の多数のレコードで構成されます。
  - `organization`: 基本情報（`id`, `login`, `name`, `description`, `avatarUrl`, `htmlUrl`, `defaultLinkUrl`）。
  - `members[]`: `userId`, `login`, `name`, `avatarUrl`, `role`。
  - `repositories[]`: `id`, `fullName`, `htmlUrl`, `language`, `stargazersCount`, `forksCount`, `updatedAt`。
  - `activitySummaryLast7Days`: `commitCount`, `additions`, `deletions`, `activeMembers`。
  - `pullRequestSummary`: `openCount`, `closedCount`, `mergedCount`。
  - `recentPullRequests[]`: PR の詳細（`number`, `title`, `state`, `merged`, `author`, `mergedBy`, `additions`, `deletions`, `changedFiles`, `createdAt`, `updatedAt`, `mergedAt`, `closedAt`, `htmlUrl`）。
  - `recentCommits[]`: `sha`, `message`, `repositoryFullName`, `authorName`, `committedAt`, `htmlUrl`。
  - `recentComments[]`: コメント情報（`id`, `user`, `targetType`, `targetId`, `content`, `createdAt`, `updatedAt`）。

#### DELETE `/api/organizations/{organizationId}`
- 認証: 必須（組織の admin/owner 権限が必要）
- 概要: 組織と関連リソースを非同期でソフトデリート。
- 成功 202 (`JobSubmissionResponse`)

---

## 活動可視化 API

### ダッシュボード

#### GET `/api/organizations/{organizationId}/dashboard`
- 認証: 必須
- 概要: ダッシュボード用の直近情報 (`DashboardResponse`) を返却。
  - `statuses[]`: メンバーごとの当日ステータス（`availableMinutes`, `status`, `statusMessage`, `updatedAt` など）。
  - `commits[]`: 最新コミット（`sha`, `repositoryFullName`, `message`, `authorName`, `committedAt`, `url`）。
  - `comments[]`: 最新コメント（`commentId`, `userId`, `login`, `avatarUrl`, `content`, `createdAt`）。

### アクティビティサマリー

#### GET `/api/organizations/{organizationId}/activity/summary`
- 認証: 必須
- クエリ: `startDate` (必須), `endDate` (必須), `groupBy` (省略時 `user`, 現状 `user` のみサポート)
- 概要: 期間内の活動をユーザー単位で集計 (`ActivitySummaryItemResponse`)。
  - 各要素: `userId`, `login`, `name`, `avatarUrl`, `commitCount`, `filesChanged`, `additions`, `deletions`, `availableMinutes`
- バリデーションエラーは 400 (`/errors/validation`)

#### GET `/api/organizations/{organizationId}/git-commit/feed`
- 認証: 必須
- クエリ: `cursor` (オプション, 前回レスポンスの `nextCursor` を指定), `limit` (1-100, 省略時 20)
- 概要: コミットの降順フィード (`CommitFeedResponse`)。
  - `items[]`: `id`, `sha`, `repositoryFullName`, `message`, `authorName`, `committerName`, `committedAt`, `url`
  - `nextCursor`: 追加取得用の ID 文字列、要素不足時は `null`

### コメント

#### POST `/api/organizations/{organizationId}/comments`
- 認証: 必須
- ボディ (`CommentCreateRequest`)
```json
{
  "targetType": "status",      // 必須
  "targetId": 101,              // 任意
  "parentCommentId": 55,        // 任意
  "content": "テキスト"         // 1〜4000 文字
}
```
- 成功 201 (`CommentCreateResponse`)
```json
{
  "commentId": 123,
  "createdAt": "2025-01-16T00:00:00Z"
}
```
- Location: `/api/organizations/{organizationId}/comments/{commentId}`

#### GET `/api/organizations/{organizationId}/comments`
- 認証: 必須
- クエリ: `targetType` (任意, 大文字小文字を無視), `targetId` (任意)
- 概要: コメント一覧 (`CommentListItemResponse`)。直近 100 件を新しい順で返却。

#### DELETE `/api/organizations/{organizationId}/comments/{commentId}`
- 認証: 必須（本人または admin/owner）
- 成功 204

### ステータス

#### POST `/api/organizations/{organizationId}/statuses`
- 認証: 必須
- ボディ (`StatusUpdateRequest`)
```json
{
  "status": "working",        // 必須: 任意の文字列（UIで制御）
  "statusMessage": "進捗共有", // 最大 2000 文字
  "capacityHours": 5,          // 0 以上 (minutes が無い場合に使用)
  "availableMinutes": 300,     // 0 以上, 指定時は capacityHours より優先
  "date": "2025-01-16"        // 省略時はサーバ日付
}
```
- 成功 200 (`StatusUpdateResponse`)
  - `personalStatus`: 自分自身の提出結果 (`submitted`, `status`, `statusMessage`, `lastSubmittedAt`, `commitCount`, `capacityHours`, `streakDays`, `latestPrUrl`)
  - `member`: チーム一覧表示用に成形済みのメンバー要素
  - `summary`: `activeToday`, `pendingStatusCount`

#### GET `/api/organizations/{organizationId}/statuses`
- 認証: 必須
- クエリ: `date` (任意, `YYYY-MM-DD`, 省略時は当日)
- 概要: 指定日のメンバーステータス一覧 (`StatusListItemResponse`)。

#### DELETE `/api/organizations/{organizationId}/statuses/{statusId}`
- 認証: 必須（本人または admin/owner）
- 成功 204

---

## リポジトリ / Pull Request API

### 同期ジョブ

#### POST `/api/repositories/{repositoryId}/pulls/sync`
- 認証: 必須 (アクセストークン必須)
- 概要: 指定リポジトリの PR・コミットを GitHub から再同期するジョブを登録。
- 成功 202 (`JobSubmissionResponse`)

### Pull Request 一覧・詳細

#### GET `/api/repositories/{repositoryId}/pulls`
- 認証: 必須
- クエリ: `state` (任意, `open`/`closed`/`merged`/`all`。省略時 or `all` は全件)、`limit` (1-100, 既定 20), `page` (0 以上, 既定 0)
- 概要: PR のページング一覧 (`PullRequestListItemResponse`)。

#### GET `/api/repositories/{repositoryId}/pulls/{pullNumber}`
- 認証: 必須
- 概要: PR 詳細 (`PullRequestDetailResponse`)。

#### GET `/api/repositories/{repositoryId}/pulls/{pullNumber}/files`
- 認証: 必須
- 概要: PR に含まれる変更ファイル一覧 (`PullRequestFileResponse`)。

#### GET `/api/organizations/{organizationId}/pulls/feed`
- 認証: 必須
- クエリ: `cursor` (任意), `limit` (1-100, 既定 20)
- 概要: 組織横断の PR フィード (`PullRequestFeedResponse`)。
  - `items[]`: `id`, `number`, `title`, `repositoryFullName`, `state`, `user`, `createdAt`, `updatedAt`, `url`
  - `nextCursor`: 追加取得用

---

## ジョブ API

#### GET `/api/jobs/{jobId}`
- 認証: 必須
- 概要: ジョブの進捗 (`JobStatusResponse`) を照会。
```json
{
  "jobId": "job-sync-org-xxxx",
  "type": "job-sync-org",
  "status": "running",
  "createdAt": "2025-01-16T00:00:00Z",
  "startedAt": "2025-01-16T00:00:05Z",
  "finishedAt": null,
  "errorMessage": null
}
```
- 見つからない場合 404 (`type": "/errors/not-found"`)

---

## GitHub 連携 API (`/api/github`)
※ すべて GitHub Access Token を保持したセッションが必要。未認証またはトークン欠如時は 401。

#### GET `/api/github/organizations`
- 概要: GitHub 上で参加している組織一覧 (`GitHubOrganization`)。
```json
[
  {
    "id": 1,
    "login": "team",
    "name": "Team",
    "description": "...",
    "avatarUrl": "https://...",
    "htmlUrl": "https://github.com/team"
  }
]
```

#### GET `/api/github/organizations/{organization}/repositories`
- 概要: 指定組織のリポジトリ一覧 (`GitHubRepository`)。
  - 要素: `id`, `name`, `description`, `htmlUrl`, `language`, `stargazersCount`, `forksCount`, `defaultBranch`, `private`, `archived`

#### GET `/api/github/organizations/{organization}/members`
- 概要: 組織メンバー一覧 (`GitHubOrganizationMember`)。
  - 要素: `id`, `login`, `avatarUrl`, `htmlUrl`, `type`, `siteAdmin`

- エラー時: GitHub API の HTTP ステータスに応じて `{"error": "..."}`。

---

## Webhook API

#### POST `/api/webhooks/github`
- 認証: 不要（GitHub からの呼び出しを想定）
- ヘッダー: `X-GitHub-Event`, `X-GitHub-Delivery`, `X-Hub-Signature-256`（任意だが送信推奨）
- ボディ: GitHub Webhook ペイロード（文字列）
- 概要: 受信したイベントを保管し、非同期処理キューへ投入。
- 成功 202
```json
{
  "status": "queued"
}
```
